import { createRequire as topLevelCreateRequire } from 'module';const require = topLevelCreateRequire(import.meta.url);import bannerUrl from 'url';const __dirname = bannerUrl.fileURLToPath(new URL('.', import.meta.url));
import E from"node:fs";import v from"node:path";import B from"node:http";var u=class extends B.IncomingMessage{constructor({method:e,url:t,headers:r,body:n,remoteAddress:s}){super({encrypted:!0,readable:!1,remoteAddress:s,address:()=>({port:443}),end:Function.prototype,destroy:Function.prototype}),typeof r["content-length"]>"u"&&(r["content-length"]=Buffer.byteLength(n).toString()),Object.assign(this,{ip:s,complete:!0,httpVersion:"1.1",httpVersionMajor:"1",httpVersionMinor:"1",method:e,headers:r,body:n,url:t}),this._read=()=>{this.push(n),this.push(null)}}};import j from"node:http";var g=`\r
\r
`,l=Symbol(),d=Symbol();function C(o){if(Buffer.isBuffer(o))return o.toString("utf8");if(typeof o=="string")return o;throw new Error(`response.write() of unexpected type: ${typeof o}`)}function y(o,e){if(Buffer.isBuffer(e)||typeof e=="string"||e instanceof Uint8Array)o[l].push(Buffer.from(e));else throw new Error(`response.write() of unexpected type: ${typeof e}`)}var c=class extends j.ServerResponse{static from(e){let t=new c(e);return t.statusCode=e.statusCode,t[d]=e.headers,t[l]=[Buffer.from(e.body)],t.end(),t}static body(e){return Buffer.concat(e[l])}static headers(e){let t=typeof e.getHeaders=="function"?e.getHeaders():e._headers;return Object.assign(t,e[d])}get headers(){return this[d]}setHeader(e,t){this._wroteHeader?this[d][e]=t:super.setHeader(e,t)}writeHead(e,t,r){let n=typeof t=="string"?r:t;for(let s in n)if(this.setHeader(s,n[s]),!this._wroteHeader)break;super.writeHead(e,t,r)}constructor({method:e}){super({method:e}),this[l]=[],this[d]={},this.useChunkedEncodingByDefault=!1,this.chunkedEncoding=!1,this._header="",this.assignSocket({_writableState:{},writable:!0,on:Function.prototype,removeListener:Function.prototype,destroy:Function.prototype,cork:Function.prototype,uncork:Function.prototype,write:(t,r,n)=>{if(typeof r=="function"&&(n=r,r=null),this._header===""||this._wroteHeader)y(this,t);else{let s=C(t),a=s.indexOf(g);if(a!==-1){let i=s.slice(a+g.length);i&&y(this,i),this._wroteHeader=!0}}typeof n=="function"&&n()}}),this.once("finish",()=>{this.emit("close")})}};import O from"next/dist/server/next-server.js";import q from"node:fs";import H from"node:path";function w(o){let e=H.join(o,"required-server-files.json"),t=q.readFileSync(e,"utf-8"),{config:r}=JSON.parse(t);return r}var _=new Set(["application/octet-stream","application/epub+zip","application/msword","application/pdf","application/rtf","application/vnd.amazon.ebook","application/vnd.ms-excel","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.openxmlformats-officedocument.wordprocessingml.document","font/otf","font/woff","font/woff2","image/bmp","image/gif","image/jpeg","image/png","image/tiff","image/vnd.microsoft.icon","image/webp","audio/3gpp","audio/aac","audio/basic","audio/mpeg","audio/ogg","audio/wavaudio/webm","audio/x-aiff","audio/x-midi","audio/x-wav","video/3gpp","video/mp2t","video/mpeg","video/ogg","video/quicktime","video/webm","video/x-msvideo","application/java-archive","application/vnd.apple.installer+xml","application/x-7z-compressed","application/x-apple-diskimage","application/x-bzip","application/x-bzip2","application/x-gzip","application/x-java-archive","application/x-rar-compressed","application/x-tar","application/x-zip","application/zip"]);function b(o){if(!o)return!1;let e=o?.split(";")[0]??"";return _.has(e)}function f(...o){}P();var h=v.join(__dirname,".next"),R=w(h),A=k();f({nextDir:h});var F=new O.default({hostname:"localhost",port:Number(process.env.PORT)||3e3,conf:{...R,compress:!1},customServer:!1,dev:!1,dir:__dirname}).getRequestHandler(),x={apiv2:o=>({get method(){return o.requestContext.http.method},get rawPath(){return o.rawPath},get url(){let{rawPath:e,rawQueryString:t}=o;return t.length>0?`${e}?${t}`:e},get body(){let{body:e,isBase64Encoded:t}=o;return Buffer.isBuffer(e)?e:typeof e=="string"?Buffer.from(e,t?"base64":"utf8"):typeof e=="object"?Buffer.from(JSON.stringify(e)):Buffer.from("","utf8")},get headers(){let{headers:e,cookies:t}=o,r={};Array.isArray(t)&&(r.cookie=t.join("; "));for(let[n,s]of Object.entries(e||{}))r[n.toLowerCase()]=s;return r},get remoteAddress(){return o.requestContext.http.sourceIp}}),cloudfront:o=>({get method(){return o.Records[0].cf.request.method},get rawPath(){return o.Records[0].cf.request.uri},get url(){let{uri:e,querystring:t}=o.Records[0].cf.request;return t.length>0?`${e}?${t}`:e},get body(){let{body:e}=o.Records[0].cf.request;return e?e.encoding==="base64"?Buffer.from(e.data,"base64"):Buffer.from(e.data,"utf8"):Buffer.from("","utf8")},get headers(){let{headers:e}=o.Records[0].cf.request,t={};for(let[r,n]of Object.entries(e))for(let{value:s}of n)s&&(t[r]=s);return t},get remoteAddress(){return o.Records[0].cf.request.clientIp}})};async function re(o){f("handler event",o);let e=o.Records?.[0]?.cf,t=e?x.cloudfront(o):x.apiv2(o),r={method:t.method,url:t.url,headers:t.headers,body:t.body,remoteAddress:t.remoteAddress};f("IncomingMessage constructor props",r);let n=new u(r),s=new c({method:r.method});await N(n,s);let a=s.statusCode||200,i=c.headers(s),p=b(Array.isArray(i["content-type"])?i["content-type"][0]:i["content-type"]),S=p?"base64":"utf8",m=c.body(s).toString(S);return f("ServerResponse data",{statusCode:a,headers:i,isBase64Encoded:p,body:m}),A.includes(t.rawPath)&&i["cache-control"]&&(i["cache-control"]="public, max-age=0, s-maxage=31536000, must-revalidate"),e?a===404?$(o):D({statusCode:a,headers:i,isBase64Encoded:p,body:m}):z({statusCode:a,headers:i,isBase64Encoded:p,body:m})}function P(){process.chdir(__dirname)}function k(){let o=v.join(h,"server","pages-manifest.json"),e=E.readFileSync(o,"utf-8");return Object.entries(JSON.parse(e)).filter(([t,r])=>r.endsWith(".html")).map(([t])=>t)}async function N(o,e){delete o.body;try{await F(o,e)}catch(t){console.error("NextJS request failed.",t),e.setHeader("Content-Type","application/json"),e.end(JSON.stringify({message:"Server failed to respond.",details:t},null,2))}}function z({statusCode:o,headers:e,body:t,isBase64Encoded:r}){let n={};Object.entries(e).filter(([a])=>a.toLowerCase()!=="set-cookie").forEach(([a,i])=>{if(i===null){n[a]="";return}n[a]=Array.isArray(i)?i.join(", "):i.toString()});let s={statusCode:o,headers:n,cookies:e["set-cookie"],body:t,isBase64Encoded:r};return f(s),s}function D({statusCode:o,headers:e,body:t,isBase64Encoded:r}){let n={};Object.entries(e).filter(([a])=>a.toLowerCase()!=="content-length").forEach(([a,i])=>{n[a]=[...n[a]||[],...Array.isArray(i)?i.map(p=>({key:a,value:p})):[{key:a,value:i.toString()}]]});let s={status:o.toString(),statusDescription:"OK",headers:n,bodyEncoding:r?"base64":"text",body:t};return f(s),s}function $(o){return o.Records[0].cf.request}export{re as handler};
